<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title></title>

<link href="style.css" rel="stylesheet" type="text/css" />

<script type="text/javascript" src="http://code.jquery.com/jquery-1.4.2.js"></script>
<script type="text/javascript" src="shared.js"></script>
<script type="text/javascript" src="table.js"></script>

<script type="text/javascript">

var players;
var playersById;
var table;

function onload()
{
	table = new LoadableTable(document.getElementById("dataTable").children[0]);
	
	table.clear();
	table.setLoading(true);
	
	callAPI({request:"getPlayers"}, onplayersLoaded);
}


function onplayersLoaded(data)
{
	players = data;
	playersById = {};
	for (var X in players)
	{
		var player = players[X];
		playersById[player.id] = player;
	}
	updateRows();
}

function updateRows()
{
	table.clear();
	table.setLoading(true);
	callAPI({request:"getMatches"}, onMatchesLoaded);
}

function onMatchesLoaded(data)
{
	table.setLoading(false);
	table.clear();
	
	var X;
	var playerRow;
	for(X in data)
	{
		playerRow = table.createRow();
		fillRowWithMatch(playerRow, data[X]);
	}
}

function fillRowWithMatch(tableRow, match)
{
	var cells = tableRow.getElementsByTagName("td");
	var date = new Date(match.date);
	cells[1].innerHTML = makePlayersStringFromIds(match.leftPlayers);
	cells[2].innerHTML = match.leftScore + " - " + match.rightScore;
	cells[3].innerHTML = makePlayersStringFromIds(match.rightPlayers);
	cells[4].innerHTML = date.getDate() + ", "+ (date.getMonth()+1) + ", " + date.getFullYear() + "<br/>" + doubleDigit(date.getHours()) + ":" + doubleDigit(date.getMinutes());
}

function makePlayersStringFromIds(playerIds)
{
	var players = [];
	for(var X in playerIds)
	{
		var player = playersById[playerIds[X]];
		players.push(player.name);
	}
	return players.join("<br/>");
}

function doubleDigit(number)
{
	if(number < 10)
	{
		return "0"+number;
	}
	return ""+number;
}

function addplayer()
{
	if(players == null)
	{
		alert("player loading in progress.");
		return;
	}
	var playername = prompt("Enter your name to add : ", "your name here");
	if(playername == null)
	{
		return;
	}
	if(findplayerByName(players, playername))
	{
		alert("player already exists : " +  playername );
	}
	else
	{
		var yes = confirm("Do you really want to add new player '" + playername+ "'?");
	   if( yes )
	   {
			callAPI({request:"addplayer", name:playername}, onplayersAdded);
	   }
	}
}

function onplayersAdded(data)
{
	updateplayerRows();
}

</script>
</head>
<body onload="onload();">
<div class="header"><a href="matches.html">Matches</a> | <a href="addmatch.html">Add Match</a>  | <a href="users.html">Players</a></div>
<br />
<table width="480" border="0" align="center" id="dataTable">
  <tr>
    <td colspan="5" align="center">Matches</td>
  </tr>
  <tr>
    <td width="60" align="center">&nbsp;</td>
    <td align="center" bgcolor="#999999">Red</td>
    <td align="center" bgcolor="#999999">Score</td>
    <td align="center" bgcolor="#999999">Blue</td>
    <td width="60">&nbsp;</td>
  </tr>
  <tr id="loadingRow">
    <td colspan="5" align="center" bgcolor="#FFCC00">Getting matches...</td>
  </tr>
  <tr id="sampleRow">
    <td align="center" >&nbsp;</td>
    <td align="center" class="tableRow">player name 1<br />
    player name 2</td>
    <td align="center" class="tableRow">2 - 1</td>
    <td align="center" class="tableRow">player name 1<br />
player name 2 </td>
    <td class="tiny">date</td>
  </tr>
</table>
<p>&nbsp;</p>
</body>
</html>

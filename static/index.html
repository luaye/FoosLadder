<!doctype html>
<html lang='en' xml:lang='en' xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" id="viewport" content="width=580;"/>
<meta name="apple-mobile-web-app-capable" content="yes">
<title>Foos Ladder</title>

<link href="css/style.css" rel="stylesheet" type="text/css" />
<link href="css/jquery-ui.css" rel="stylesheet" type="text/css" />

<script type="text/javascript" src="jslib/jquery-1.8.2.min.js"></script>
<script type="text/javascript" src="jslib/jquery-ui-1.8.23.custom.min.js"></script>
<script type="text/javascript" src="jslib/jquery-ui-timepicker-addon.js"></script>
<script type="text/javascript" src="jslib/jquery.sparkline.js"></script>
<script type="text/javascript" src="js/shared.js"></script>
<script type="text/javascript" src="js/table.js"></script>
<script type="text/javascript" src="js/matchesView.js"></script>
<script type="text/javascript" src="js/addMatchView.js"></script>
<script type="text/javascript" src="js/playersView.js"></script>
<script type="text/javascript" src="js/graphView.js"></script>

<script src="//connect.facebook.net/en_US/all.js"></script>

<script type="text/javascript">
var matchesView;
var playersView;
var addMatchView;
var facebookAccessToken;

var currentView;
var self = this;

function onLoad()
{
	
	var matchesTable = new LoadableTable(document.getElementById("matchesTable").children[0]);
	matchesView = new MatchesView(matchesTable);
	matchesView.loadPlayers = loadPlayers;
	matchesView.loadMatches = loadMatches;
	matchesView.hide();
	
	var playersTable = new LoadableTable(document.getElementById("playersTable").children[0]);
	playersView = new PlayersView(playersTable);
	playersView.loadPlayers = loadPlayers;
	playersView.hide();
	
	var addMatchTable = document.getElementById("addMatchTable").children[0];
	addMatchView = new AddMatchView(addMatchTable);
	addMatchView.loadPlayers = loadPlayers;
	addMatchView.onMatchAdded = onMatchAdded;
	addMatchView.hide();
	
	var graphDiv = $("#graphView");
	graphView = new GraphView(graphDiv);
	graphView.loadPlayers = loadPlayers;
	graphView.hide();
	
	
	var location = String(window.location);
	var hashPath = "";
	var hashIndex = location.indexOf("#");
	if(hashIndex >= 0)
	{
		hashPath = location.substring(hashIndex + 1);
	}
	var hashBits = hashPath.split("/");
	
	if(hashBits[0] == "match" || hashBits[0] == "matches")
	{
		showMatches();
	}
	else if(hashBits[0] == "addMatch")
	{
		showAddMatch();
	}
	else
	{
		showPlayers();
	}
	
	if(FACEBOOK_ENABLED)
	{
		FB.Event.subscribe('auth.statusChange', function(response)
		{
			if(response.authResponse != null)
			{
				facebookAccessToken = response.authResponse.accessToken;
			}
			else
			{
				facebookAccessToken = null;
			}
			setFacebookLoginStatusDisplay(facebookAccessToken ? true : false);
		});

		FB.init({
			appId      : FACEBOOK_APP_ID,
			channelUrl : FACEBOOK_APP_URL_PART,
			status     : true,
			cookie     : true,
			xfbml      : true
		});
	}
	else
	{
		setFacebookLoginStatusDisplay(true);
	}
}

function setFacebookLoginStatusDisplay(loggedIn)
{
	var loggedinButtons = document.getElementsByClassName("fbLoggedIn");
	setStyleDisplayOfList(loggedinButtons, loggedIn ? '' : 'none');
			
	var loggedoutButtons = document.getElementsByClassName("fbLoggedOut");
	setStyleDisplayOfList(loggedoutButtons, loggedIn ? 'none' : '');	
}

function setStyleDisplayOfList(nodelist, value)
{
	for(var i = nodelist.length - 1; i >= 0; i--)
	{
		var element = nodelist[i];
		element.style.display = value;
	}
}

function loadPlayers()
{
	callAPI({request:"getPlayers"}, self.onPlayersLoaded);
}

function onPlayersLoaded(players)
{
	graphView.setPlayers(players);
	matchesView.setPlayers(players);
	playersView.setPlayers(players);
	addMatchView.setPlayers(players);
}

function loadMatches()
{
	matchesView.onReloading();
	graphView.onReloading();
	callAPI({request:"getMatches"}, onMatchesLoaded);
}

function onMatchesLoaded(data)
{
	matchesView.setMatches(data);
	graphView.setMatches(data);
}

function onMatchAdded()
{
	matchesView.onReloading()
	loadPlayers();
	loadMatches();
	setCurrentView(matchesView);
}

function showMatches()
{
	setCurrentView(matchesView);
}

function showAddMatch()
{
	setCurrentView(addMatchView);
}

function showPlayers()
{
	setCurrentView(playersView);
}

function showGraph()
{
	setCurrentView(graphView);
}


function setCurrentView(view)
{
	if(currentView)
	{
		currentView.hide();
		hideActivePlayerSelectDialog();
	}
	currentView = view;
	if(currentView)
	{
		currentView.show();
	}
}


var activePlayerSelectDialog;

function showPlayerSelectionDialog(title, buttonObjs)
{
	hideActivePlayerSelectDialog();
	var dialogDiv = $(document.createElement('div'));
	activePlayerSelectDialog = dialogDiv;
	
	var dialogClickOutsideHandler = function(e)
	{
		if(dialogDiv.dialog('isOpen')
		&& !jQuery(e.target).is('.ui-dialog, a')
		&& !jQuery(e.target).closest('.ui-dialog').length)
		{
			hideActivePlayerSelectDialog();
		}
	}
	
	dialogDiv.dialog(
	{
		title:title,
		minWidth:480,
		position:['center', 60],
		open: function()
			{
			   jQuery('body').bind('click',	dialogClickOutsideHandler);
			},
		close: function()
			{
			   jQuery('body').unbind('click', dialogClickOutsideHandler);
			},
		buttons:buttonObjs
	});
	$(".ui-dialog-content").hide();	
}

function hideActivePlayerSelectDialog()
{
	if(activePlayerSelectDialog)
	{
		activePlayerSelectDialog.dialog("close");
		activePlayerSelectDialog = null;
	}
}
</script>
</head> 
<body onLoad="onLoad()"> 
<div id="fb-root"></div>
<div class="header"><a href="javascript:showMatches()">Matches</a> | <a href="javascript:showAddMatch()">Add Match</a>  | <a href="javascript:showPlayers()">Players</a>  | <a href="javascript:showGraph()">Graph</a></div>
<br />
<table border="0" align="center" id="matchesTable">
  <tr>
    <td width="80" align="center">&nbsp;</td>
    <td width="165" align="center" bgcolor="#999999">Yellow</td>
    <td width="60" align="center" bgcolor="#999999">Score</td>
    <td width="165" align="center" bgcolor="#999999">White</td>
    <td width="80" align="center" >&nbsp;</td>
  </tr>
  <tr id="loadingRow">
    <td colspan="5" align="center" bgcolor="#FFCC00">Getting matches...</td>
  </tr>
  <tr id="sampleRow">
    <td colspan="5">
    <table width="100%" border="0">
      <tr>
        <td width="80" align="center" class="tiny"><matchDate>1, 1, 2012<br />18:00</matchDate></td>
        <td width="40" class="tableRow"><leftScoreChange>11</leftScoreChange></td>
        <td width="125" class="tableRow"><leftAttacker>Left Attacker</leftAttacker><br />
    <leftDefender>Left Defender</leftDefender></td>
        <td width="60" class="tableRow"><leftScore>10</leftScore> - <rightScore>9</rightScore></td>
        <td width="125" class="tableRow"><rightAttacker>Right Attacker</rightAttacker><br />
    <rightDefender>Right Defender</rightDefender></td>
        <td width="40" class="tableRow"><rightScoreChange>-11</rightScoreChange></td>
        <td width="80" align="center"><commentToggle><a href="#"><span  style="color:#569; font-size:12px; text-decoration:none;"><img src="comments.gif" width="20" height="16" style="vertical-align:text-top" ><span class=\"fb-comments-count\" data-href=\""+makeCommentURL(key)+"\">0</span></span></a></commentToggle></td>
      </tr>
      <tr>
        <td colspan="7">
        <commentHolder>Facebook comment</commentHolder>
        box</td>
        </tr>
    </table></td>
  </tr>
  <tr>
    <td colspan="5"><a href="javascript:matchesView.exportData(this)" class="tiny">Export</a></td>
  </tr>
</table>


<table width="580" border="0" align="center" id="playersTable">
  <tr>
    <td colspan="6" align="center"><a href="javascript:playersView.addPlayer()" class="tiny">Add player</a>  |
      <a href="javascript:playersView.rebuiltStats()" class="tiny">Rebuilt stats</a> |
      <a href="javascript:playersView.repeatMatches()" class="tiny">Repeat matches</a> |
      <a href="javascript:playersView.loadPlayers()" class="tiny">Reload</a></td>
  </tr>
  <tr id="headerRow">
    <td width="160" align="center" bgcolor="#999999"><a href="javascript:playersView.toggleSortBy('name')">Name</a></td>
    <td width="100" align="center" bgcolor="#999999"><a href="javascript:playersView.toggleSortBy('mixedStats.score')">mixed<br />
    rating</a></td>
    <td width="100" align="center" bgcolor="#999999"><a href="javascript:playersView.toggleSortBy('duoStats.score')">duo<br />
    rating</a></td>
    <td width="100" align="center" bgcolor="#999999">duo<br />
    <a href="javascript:playersView.toggleSortBy('duoStats.wins')">wins</a>/<a href="javascript:playersView.toggleSortBy('duoStats.games')">games</a></td>
    <td width="100" align="center" bgcolor="#999999"><a href="javascript:playersView.toggleSortBy('soloStats.score')">solo<br />
    rating</a></td>
    <td width="100" align="center" bgcolor="#999999">solo<br />
    <a href="javascript:playersView.toggleSortBy('soloStats.wins')">win</a>/<a href="javascript:playersView.toggleSortBy('soloStats.games')">games</a></td>
  </tr>
  <tr id="loadingRow">
    <td colspan="6" align="center" bgcolor="#FFCC00">Getting players...</td>
  </tr>
  <tr id="sampleRow">
    <td class="tableRow" style="text-align:left"><playerImage></playerImage> <playerName>NAME</playerName></td>
    <td class="tableRow"><mixedScore>3</mixedScore></td>
    <td class="tableRow"><duoScore>1</duoScore></td>
    <td class="tableRow"><duoWins>2/3</duoWins></td>
    <td class="tableRow"><soloScore>2</soloScore></td>
    <td class="tableRow"><soloWins>2/2</soloWins></td>
  </tr>
  <tr>
    <td colspan="7">
	<div class="fb-comments" data-href="http://foos.apelabs.net#players" data-num-posts="3" data-width="560" mobile="false"></div>
    </td>
  </tr>
  <tr>
    <td colspan="6"><a href="javascript:playersView.exportData(this)" class="tiny">Export</a></td>
  </tr>
</table>


<table border="0" align="center" cellpadding="4" cellspacing="0" id="addMatchTable">
  <tr>
    <td align="right" bgcolor="#FFFF55"><strong>Yellow</strong></td>
    <td align="center" bgcolor="#FFFF55">&nbsp;</td>
    <td width="40" rowspan="2" align="center">
      VS    </td>
    <td align="center" bgcolor="#AAAAAA">&nbsp;</td>
    <td align="left" bgcolor="#AAAAAA"><strong>White</strong></td>
  </tr>
  <tr>
  	<td width="150" height="80" align="right"  bgcolor="#EEEE44" id='leftRating'>
  	  <a href="javascript:addMatchView.selectPlayer(true, 0)"><span class="leftAttacker">Left offence</span></a>
  	  <br /><br/>
  	  <a href="javascript:addMatchView.selectPlayer(true, 1)"><span class="leftDefender">Left defender</span></a>
      </td>
    <td width="50" align="right" bgcolor="#FFFF55">
      <br>
      <select name="leftScore" id="leftScore">
        <option>0</option>
        <option>1</option>
        <option>2</option>
        <option>3</option>
        <option>4</option>
        <option>5</option>
        <option>6</option>
        <option>7</option>
        <option>8</option>
        <option>9</option>
        <option selected>10</option>
      </select>[<span id='leftExpectedScore'>x</span>]
    </td>
    <td width="50" bgcolor="#AAAAAA">
    <br>
    <select name="rightScore" id="rightScore">
        <option>0</option>
        <option>1</option>
        <option>2</option>
        <option>3</option>
        <option>4</option>
        <option>5</option>
        <option>6</option>
        <option>7</option>
        <option>8</option>
        <option>9</option>
        <option selected>10</option>
      </select>[<span id='rightExpectedScore'>x</span>]
    </td>
    <td width="150" align="left" bgcolor="#999999">
      <a href="javascript:addMatchView.selectPlayer(false, 0)"><span class="rightAttacker">Right offence</span></a>
      <br /><br/>
      <a href="javascript:addMatchView.selectPlayer(false, 1)"><span class="rightDefender">Right defender</span></a>
    </td>
  </tr>
  <tr>
    <td colspan="5">
    Date: 
      now?
      <input name="dateNow" type="checkbox" id="dateNow" checked="checked" onchange="addMatchView.dateNowChanged();"/>
      <input type="text" id="datePicker" name="datePicker" style="width: 140px" />
    </td>
  </tr>
  <tr>
    <td colspan="5" align="center"><div class="fb-login-button fbLoggedOut" data-show-faces="false" data-width="200" data-max-rows="1">Login to Submit</div> <div class="fbLoggedIn" ><input type="submit" name="submit" id="submit" value="Submit" onClick="addMatchView.onSubmit()"/> </div></td>
  </tr>
</table>
<div id="graphView" style="text-align:center"><a href="javascript:graphView.selectPlayers();">Choose players</a><br>
  <br>
<graphSelectedPlayers>players...</graphSelectedPlayers>
<br>
<br>
</div>
<script>

document.getElementById("matchesTable").children[0].style.display = 'none';
document.getElementById("playersTable").children[0].style.display = 'none';
document.getElementById("addMatchTable").children[0].style.display = 'none';

</script>
<div id="exportArea"></div>
</body> 
</html>

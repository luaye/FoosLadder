<!doctype html>
<html lang='en' xml:lang='en' xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" id="viewport" content="width=580; user-scalable=no"/>
<meta name="apple-mobile-web-app-capable" content="yes">
<title>Foos Ladder</title>

<link href="css/style.css" rel="stylesheet" type="text/css" />
<link href="css/jquery-ui.css" rel="stylesheet" type="text/css" />

<script type="text/javascript" src="js/jquery-1.8.1.min.js"></script>
<script type="text/javascript" src="js/jquery-ui-1.8.23.custom.min.js"></script>
<script type="text/javascript" src="js/jquery-ui-timepicker-addon.js"></script>
<script type="text/javascript" src="js/shared.js"></script>
<script type="text/javascript" src="js/table.js"></script>
<script type="text/javascript" src="js/matchesView.js"></script>
<script type="text/javascript" src="js/addMatchView.js"></script>
<script type="text/javascript" src="js/playersView.js"></script>

<script src="//connect.facebook.net/en_US/all.js"></script>

<script type="text/javascript">
var matchesView;
var playersView;
var addMatchView;
var facebookAccessToken;

var currentView;
var self = this;

function onLoad()
{
	
	var matchesTable = new LoadableTable(document.getElementById("matchesTable").children[0]);
	matchesView = new MatchesView(matchesTable);
	matchesView.loadPlayers = loadPlayers;
	matchesView.hide();
	
	var playersTable = new LoadableTable(document.getElementById("playersTable").children[0]);
	playersView = new PlayersView(playersTable);
	playersView.loadPlayers = loadPlayers;
	playersView.hide();
	
	var addMatchTable = document.getElementById("addMatchTable").children[0];
	addMatchView = new AddMatchView(addMatchTable);
	addMatchView.loadPlayers = loadPlayers;
	addMatchView.onMatchAdded = onMatchAdded;
	addMatchView.hide();
	
	var location = String(window.location);
	var hashPath = "";
	var hashIndex = location.indexOf("#");
	if(hashIndex >= 0)
	{
		hashPath = location.substring(hashIndex + 1);
	}
	var hashBits = hashPath.split("/");
	
	if(hashBits[0] == "match" || hashBits[0] == "matches")
	{
		showMatches();
	}
	else if(hashBits[0] == "addMatch")
	{
		showAddMatch();
	}
	else
	{
		showPlayers();
	}

FB.Event.subscribe('auth.statusChange', function(response)
{
	if(response.authResponse != null)
	{
		facebookAccessToken = response.authResponse.accessToken;
	}
	else
	{
		facebookAccessToken = null;
	}
	
	var loggedinButtons = document.getElementsByClassName("fbLoggedIn");
	setStyleDisplayOfList(loggedinButtons, facebookAccessToken ? '' : 'none');
	
	var loggedoutButtons = document.getElementsByClassName("fbLoggedOut");
	setStyleDisplayOfList(loggedoutButtons, facebookAccessToken ? 'none' : '');
});

function setStyleDisplayOfList(nodelist, value)
{
	for(var i = nodelist.length - 1; i >= 0; i--)
	{
		var element = nodelist[i];
		element.style.display = value;
	}
}

  FB.init({
    appId      : FACEBOOK_APP_ID,
    channelUrl : FACEBOOK_APP_URL_PART,
    status     : true,
    cookie     : true,
    xfbml      : true
  });
}

function loadPlayers()
{
	callAPI({request:"getPlayers"}, self.onPlayersLoaded);
}

function onPlayersLoaded(players)
{
	matchesView.setPlayers(players);
	playersView.setPlayers(players);
	addMatchView.setPlayers(players);
}

function onMatchAdded()
{
	loadPlayers();
	matchesView.loadMatches();
	setCurrentView(matchesView);
}

function showMatches()
{
	setCurrentView(matchesView);
}

function showAddMatch()
{
	setCurrentView(addMatchView);
}

function showPlayers()
{
	setCurrentView(playersView);
}


function setCurrentView(view)
{
	if(currentView)
	{
		currentView.hide();
	}
	currentView = view;
	if(currentView)
	{
		currentView.show();
	}
}

</script>
</head> 
<body onLoad="onLoad()"> 
<div id="fb-root"></div>

<div class="header"><a href="javascript:showMatches()">Matches</a> | <a href="javascript:showAddMatch()">Add Match</a>  | <a href="javascript:showPlayers()">Players</a></div>
<br />
<table border="0" align="center" id="matchesTable">
  <tr>
    <td colspan="5" align="center">Matches</td>
  </tr>
  <tr>
    <td width="80" align="center">&nbsp;</td>
    <td width="165" align="center" bgcolor="#999999">Yellow</td>
    <td width="60" align="center" bgcolor="#999999">Score</td>
    <td width="165" align="center" bgcolor="#999999">White</td>
    <td width="80" align="center" >&nbsp;</td>
  </tr>
  <tr id="loadingRow">
    <td colspan="5" align="center" bgcolor="#FFCC00">Getting matches...</td>
  </tr>
  <tr id="sampleRow">
    <td colspan="5">
    <table width="100%" border="0">
      <tr>
        <td width="80" align="center" class="tiny"><matchDate>1, 1, 2012<br />18:00</matchDate></td>
        <td width="40" class="tableRow"><leftScoreChange>11</leftScoreChange></td>
        <td width="125" class="tableRow"><leftAttacker>Left Attacker</leftAttacker><br />
    <leftDefender>Left Defender</leftDefender></td>
        <td width="60" class="tableRow"><leftScore>10</leftScore> - <rightScore>9</rightScore></td>
        <td width="125" class="tableRow"><rightAttacker>Right Attacker</rightAttacker><br />
    <rightDefender>Right Defender</rightDefender></td>
        <td width="40" class="tableRow"><rightScoreChange>-11</rightScoreChange></td>
        <td width="80" align="right" class="tiny"><commentToggle>2 comments</commentToggle></td>
      </tr>
      <tr>
        <td colspan="7">
        <commentHolder>Facebook comment</commentHolder>
        box</td>
        </tr>
    </table></td>
  </tr>
  <tr>
    <td colspan="5"><a href="javascript:matchesView.exportData(this)" class="tiny">Export</a></td>
  </tr>
</table>


<table width="580" border="0" align="center" id="playersTable">
  <tr>
    <td colspan="6" align="center">Players<br />
      <a href="javascript:playersView.addPlayer()" class="tiny">Add player</a>  |
      <a href="javascript:playersView.rebuiltStats()" class="tiny">Rebuilt stats</a> |
      <a href="javascript:playersView.repeatMatches()" class="tiny">Repeat matches</a></td>
  </tr>
  <tr id="headerRow">
    <td width="160" align="center" bgcolor="#999999"><a href="javascript:playersView.toggleSortBy('name')">Name</a></td>
    <td width="100" align="center" bgcolor="#999999"><a href="javascript:playersView.toggleSortBy('mixedStats.score')">mixed<br />
    score</a></td>
    <td width="100" align="center" bgcolor="#999999"><a href="javascript:playersView.toggleSortBy('duoStats.score')">duo<br />
    score</a></td>
    <td width="100" align="center" bgcolor="#999999">duo<br />
    <a href="javascript:playersView.toggleSortBy('duoStats.wins')">wins</a>/<a href="javascript:playersView.toggleSortBy('duoStats.games')">games</a></td>
    <td width="100" align="center" bgcolor="#999999"><a href="javascript:playersView.toggleSortBy('soloStats.score')">solo<br />
    score</a></td>
    <td width="100" align="center" bgcolor="#999999">solo<br />
    <a href="javascript:playersView.toggleSortBy('soloStats.wins')">win</a>/<a href="javascript:playersView.toggleSortBy('soloStats.games')">games</a></td>
  </tr>
  <tr id="loadingRow">
    <td colspan="6" align="center" bgcolor="#FFCC00">Getting players...</td>
  </tr>
  <tr id="sampleRow">
    <td class="tableRow" style="text-align:left"><playerImage></playerImage> <playerName>NAME</playerName></td>
    <td class="tableRow"><mixedScore>3</mixedScore></td>
    <td class="tableRow"><duoScore>1</duoScore></td>
    <td class="tableRow"><duoWins>2/3</duoWins></td>
    <td class="tableRow"><soloScore>2</soloScore></td>
    <td class="tableRow"><soloWins>2/2</soloWins></td>
  </tr>
  <tr>
    <td colspan="7">
	<div class="fb-comments" data-href="http://foos.apelabs.net#players" data-num-posts="3" data-width="560" mobile="false"></div>
    </td>
  </tr>
  <tr>
    <td colspan="6"><a href="javascript:playersView.exportData(this)" class="tiny">Export</a></td>
  </tr>
</table>


<table width="480" border="0" align="center" cellpadding="4" cellspacing="0" id="addMatchTable">
  <tr>
    <td colspan="7" align="center">Add Match</td>
  </tr>
  <tr>
    <td colspan="3" align="center" bgcolor="#FFFF55"><strong>Yellow</strong></td>
    <td width="50" rowspan="2" align="center">
      VS    </td>
    <td colspan="3" align="center" bgcolor="#AAAAAA"><strong>White</strong></td>
  </tr>
  <tr>
  	<td  bgcolor="#FFFF55" id='leftRating'>&nbsp;</td>
    <td align="right" bgcolor="#FFFF55"><select name="leftPlayer1" id="leftPlayer1" onchange="addMatchView.playerChanged();">
      </select><br />
      <select name="leftPlayer2" id="leftPlayer2" onchange="addMatchView.playerChanged();">
      </select>
    </td>
    <td width="40" align="right" bgcolor="#FFFF55">
      <input name="leftScore" type="text" id="leftScore" size="4" maxlength="2" />
      <br/>[<span id='leftExpectedScore'>x</span>]
    </td>
    <td width="40" bgcolor="#AAAAAA">
      <input name="rightScore" type="text" id="rightScore" size="4" maxlength="2" />
      <br/>[<span id='rightExpectedScore'>x</span>]
    </td>
    <td align="left" bgcolor="#AAAAAA"><select name="rightPlayer1" id="rightPlayer1" onchange="addMatchView.playerChanged();">
      </select><br /><select name="rightPlayer2" id="rightPlayer2" onchange="addMatchView.playerChanged();">
</select>      </td>
  	<td  bgcolor="#AAAAAA" id='rightRating'>&nbsp;</td>
  </tr>
  <tr>
    <td colspan="7">
    Date: 
      now?
      <input name="dateNow" type="checkbox" id="dateNow" checked="checked" onchange="addMatchView.dateNowChanged();"/>
      <input type="text" id="datePicker" name="datePicker" style="width: 140px" />
    </td>
  </tr>
  <tr>
    <td colspan="7" align="center"><div class="fb-login-button fbLoggedOut" data-show-faces="false" data-width="200" data-max-rows="1">Login to Submit</div> <div class="fbLoggedIn" ><input type="submit" name="submit" id="submit" value="Submit" onClick="addMatchView.onSubmit()"/> </div></td>
  </tr>
</table>

<div id="exportArea"></div>
</body> 
</html>
